from langchain.prompts import ChatPromptTemplate

PROMPT_TEMPLATE = """
請扮演一位專業且客觀的股市分析師，根據下方所有與 {company} 相關的新聞內容進行整體分析，評估這些消息綜合而言可能對該公司隔日的市場情緒與股價波動產生的影響。
請將所有新聞內容整合為一個總體結論，禁止逐則分析或引用原文，不要輸出針對其他公司的分析資訊。
輸出必須嚴格包含兩行內容，每行之間使用一個換行字元分隔，嚴禁輸出任何多餘說明、格式標記或原始內容。
第一行請輸出一個介於 0 到 1 之間的實數(例如：0.0、0.3、0.6、1.0)，表示所有新聞對 {company} 股票市場情緒的影響。0 表示市場情緒負面，股票可能會下跌；1 表示市場情緒正面，股票可能會上漲；0.5 則表示中性，無明顯漲跌傾向或資訊無關。
第二行請簡短說明你產出此判斷的主要原因或邏輯依據，僅限一行簡潔文字，不超過一句話。

在分析新聞時，請根據以下的經驗法則進行評估：
{rules}
{company_rules}

---

範例新聞1:
宏達電 (2498-TW) 今 (1) 日公布財報，第三季稅後虧損 9.8 億元，虧損較上季與去年同期擴大，每股虧損 1.19 元，續探同期新低；累計前三季虧損 24.86 億元，較去年同期小幅收斂，每股虧 3.01 元。宏達電第三季營收 10.8 億元，季增 7.2%、年減 19.4%；毛利率 39.4%，季增 0.2 個百分點，年增 9.5 個百分點；營利率 - 105.3%，虧損較上季收斂、較去年同期增加。從前三季來看，營收 31.93 億元，年減 17.4%；毛利率 38.76%，年增 8.6 個百分點；營益率 - 103.35%，虧損較去年同期增加；稅後虧損 24.86 億元，虧損較去年同期小幅收斂，每股虧損 3.01 元。展望後市，HTC 亞太區總經理黃昭穎指出，旗下首款支援元宇宙的手機 Desire 22 pro，繼在台灣、歐洲市場上市後，也進軍日本市場且預購狀況不錯，加上手機用戶移轉至元宇宙的綜效顯現，第四季營運不看淡。回顧第三季，宏達電表示，推出 VIVE Focus 3 眼球追蹤套件與表情偵測套件，以及實景應用軟體套件，為 VR 一體機提升虛擬世界人際互動真實感。應用合作方面，包括與 MyndVR 合作推出 DigitalTherapyNow 網站，共同支持美國 2022 年數位醫療處方法案，該法案將 VR 裝置認可為處方醫療處置之一、與 MyndVR 及 Virti 合作，於華府 ARVR 政策會議 (ARVR Policy Conference) 為政策制定者演示 VR 裝置。

範例輸出1:
0.4
持續虧損與營收下滑壓抑市場信心，雖有新產品與擴展計畫但短期正面效益有限。

---

範例新聞2:
晶圓代工廠世界先進 (5347-TW) 今 (1) 日公告第三季財報，雙率均符合財測預期，稅後純益 38.23 億元，季減 21.76%，年增 16.27%，每股純益 2.33 元，為近 3 季低點；前三季稅後純益 128.01 億元，年增近 6 成，每股純益 7.81 元。世界先進第三季營收 133.28 億元，季減 12.9%，年增 12.2%，毛利率 45%，季減 4.97 個百分點，年減 0.79 個百分點，營益率 33.35%，季減 5.29 個百分點，年減 0.87 個百分點；稅後純益 38.23 億元，季減 21.76%，年增 16.27%，每股純益 2.33 元。世界先進前三季累計營收 421.21 億元，年增 34.95%，毛利率 47.88%，年增 5.95 個百分點，營益率 36.43%，年增 5.99 個百分點；稅後純益 128.01 億元，年增 57.96%，每股純益 7.81 元。世界先進法說時預估，以新台幣平均匯率 29.5 元兌換一美元假設，第三季營收估達 129-133 億元，相當於季減約 13-15%，毛利率估 44-46%，營益率 32.5-34.5%，雙率均將較第二季下滑，財報出爐符合預期。世界先進第三季受消費性電子終端市場需求疲弱影響，客戶積極進行庫存調整，訂單明顯由過去高點下滑，產能利用率也下滑至 81-83%。世界先進認為，面板客戶庫存調整情況將延續至第四季，而俄烏戰爭、封城及通膨等不確定因素造成的庫存修正影響，預估也會延續到明年上半年。

範例輸出2:
0.5
財報表現符合預期但營收與獲利下滑及庫存調整壓力使短期市場情緒維持中性。

---

範例新聞3:
環球晶 (6488-TW) 今 (1) 日公布第三季財報，由於第三季世創股價平穩，加上匯兌收益助攻，帶動獲利衝高，單季稅後純益達 51.1 億元，季增 88.2%，年增 64.6%，每股純益 11.74 元，獲利、EPS 同創單季新高，前三季每股賺 22 元。環球晶第三季營收 180.5 億元，季增 2.9%，年增 17.5%，毛利率 43.7%，季增 0.1 個百分點，年增 4.6 個百分點，營益率 35.1%，季減 1.4 個百分點，年增 4.7 個百分點；稅後純益 51.1 億元，季增 88.2%，年增 64.6%，每股純益 11.74 元。環球晶前三季累計營收 518.99 億元，年增 14.4%，毛利率 43.3%，年增 6.3 個百分點，營益率 35.9%，年增 7.5 個百分點；稅後純益 95.73 億元，年減 1.8%，每股純益 22 元。環球晶截至 9 月底預收貨款餘額也締造新紀錄、達 382.1 億元。 環球晶指出，半導體產業雖受總體經濟因素與消費性電子產品需求放軟影響，庫存壓力增加，但車用與工業應用需求依舊強勁，加上各國政府推進能源轉型及淨零碳排相關政策，都有望持續推升半導體需求。環球晶強調，公司擁有 3 至 12 吋完整的產品光譜，能滿足客戶全方位需求，以因應單一產品的市場波動，並藉由靈活資產配置與充裕現金部位，抵禦市場動盪。

範例輸出3:
0.8
獲利創高與需求前景穩健顯示公司基本面強勁，激勵正面市場情緒。

====================

以下是提供的新聞資訊 :

{context}
"""


def get_prompt(company, rules, company_rules, results):
    context_text = "\n\n---\n\n".join(results)
    rules_text = "\n".join([doc.page_content for doc, _score in rules])
    company_rules_text = "\n".join(company_rules)
    prompt_template = ChatPromptTemplate.from_template(PROMPT_TEMPLATE)
    prompt = prompt_template.format(context=context_text, company=company, rules=rules_text, company_rules=company_rules_text)
    return prompt
